<script>
    class AdminDashboard {
        constructor() {
            this.agentsData = [];
            this.init();
        }

        async init() {
            this.loadAdminProfile();
            this.bindEvents();
        }

        loadAdminProfile() {
            const session = localStorage.getItem('callHammerSession');
            if (session) {
                const s = JSON.parse(session);
                document.getElementById('adminName').textContent = s.user.name;
                document.getElementById('adminRole').textContent = s.user.role.toUpperCase();
                if (s.user.role === 'admin') document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }
        }

        refreshDashboard() {
            this.agentsData = portal.leadsData || [];
            const employees = portal.employeeList || [];
            
            const total = this.agentsData.length;
            const cancelled = this.agentsData.filter(l => (l.Status || '').toLowerCase().includes('cancel')).length;
            const rate = total > 0 ? ((cancelled / total) * 100).toFixed(1) : 0;
            const incentives = this.agentsData.filter(l => (l.Status || '').toLowerCase() === 'approved').length * 50;
            
            document.getElementById('activeAgents').textContent = employees.length;
            document.getElementById('totalTeamAppointments').textContent = total;
            document.getElementById('avgCancellationRate').textContent = `${rate}%`;
            document.getElementById('totalTeamIncentives').textContent = portal.formatCurrency(incentives);
            
            this.updatePayrollTable(employees);
            this.updateEmployeeCards(employees);
            this.initializeCharts();
        }

        updatePayrollTable(employees) {
            const tbody = document.getElementById('payrollTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            let totalPool = 0;

            employees.forEach(emp => {
                const base = parseFloat(emp['Base Rate']) || 0;
                const agentLeads = this.agentsData.filter(l => l.Agent === emp['Employee Name']);
                const incentives = agentLeads.filter(l => (l.Status || '').toLowerCase() === 'approved').length * 50;
                totalPool += (base + incentives);

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4"><div class="font-bold">${emp['Employee Name']}</div><div class="text-xs text-gray-400">${emp.Email}</div></td>
                        <td class="px-6 py-4">${portal.formatCurrency(base)}</td>
                        <td class="px-6 py-4 text-yellow-600">${portal.formatCurrency(incentives)}</td>
                        <td class="px-6 py-4 font-bold">${portal.formatCurrency(base + incentives)}</td>
                        <td class="px-6 py-4"><span class="performance-badge high">ACTIVE</span></td>
                    </tr>`;
            });
            document.getElementById('totalPayrollAmount').textContent = portal.formatCurrency(totalPool);
        }

        updateEmployeeCards(employees) {
            const container = document.getElementById('employeeCards');
            if (!container) return;
            container.innerHTML = employees.map(emp => {
                const initials = emp['Employee Name'].split(' ').map(n => n[0]).join('');
                return `
                    <div class="bg-white border rounded-xl p-6 shadow-sm">
                        <div class="flex items-center space-x-4 mb-6">
                            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-700 font-bold">${initials}</div>
                            <div><h3 class="font-bold">${emp['Employee Name']}</h3><p class="text-[10px] text-gray-400 uppercase">${emp.Role}</p></div>
                        </div>
                        <div class="space-y-2 mb-6 text-xs">
                            <div class="flex justify-between"><span>Manager:</span><span class="font-bold">${emp.Manager_Email || 'Admin'}</span></div>
                            <div class="flex justify-between"><span>Rate:</span><span class="font-bold text-yellow-600">${portal.formatCurrency(emp['Base Rate'])}</span></div>
                        </div>
                        <button onclick="portal.offboardEmployee('${emp.Email}')" class="w-full py-2 text-[10px] font-bold text-red-500 border rounded-lg">OFFBOARD</button>
                    </div>`;
            }).join('');
        }

        initializeCharts() {
            const counts = {};
            this.agentsData.forEach(l => { counts[l.Agent] = (counts[l.Agent] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            echarts.init(document.getElementById('topPerformersChart')).setOption({
                xAxis: { type: 'value' },
                yAxis: { type: 'category', data: sorted.map(i => i[0]).reverse() },
                series: [{ data: sorted.map(i => i[1]).reverse(), type: 'bar', itemStyle: { color: '#FBBF24' } }]
            });
        }

        bindEvents() {
            document.getElementById('timeFrameFilter').onchange = (e) => { portal.currentFilter = e.target.value; portal.fetchAllData(); };
        }
    }
    let adminDashboard = new AdminDashboard();
    window.adminDashboard = adminDashboard;
    function openAddEmployeeModal() { document.getElementById('addEmployeeModal').classList.remove('hidden'); }
    function closeAddEmployeeModal() { document.getElementById('addEmployeeModal').classList.add('hidden'); }
</script>
